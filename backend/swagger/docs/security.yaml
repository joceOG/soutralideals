# üõ°Ô∏è DOCUMENTATION SWAGGER - S√âCURIT√â & OPTIMISATIONS

paths:
  /api/utilisateur/login:
    post:
      tags:
        - Authentification
      summary: "üîê Connexion utilisateur"
      description: "Authentification avec rate limiting (5 tentatives/15min par IP)"
      security:
        - rateLimit: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  description: "Email de l'utilisateur"
                  example: "user@soutralideals.com"
                password:
                  type: string
                  minLength: 8
                  description: "Mot de passe de l'utilisateur"
                  example: "motdepasse123"
      responses:
        '200':
          description: "Connexion r√©ussie"
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: "Token JWT"
                  user:
                    type: object
                    description: "Informations utilisateur"
        '401':
          description: "Identifiants invalides"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: "Trop de tentatives de connexion"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'
              example:
                error: "Trop de tentatives de connexion, veuillez r√©essayer plus tard."
                retryAfter: "15 minutes"

  /api/utilisateur/register:
    post:
      tags:
        - Authentification
      summary: "üìù Inscription utilisateur"
      description: "Cr√©ation de compte avec rate limiting (5 tentatives/15min par IP)"
      security:
        - rateLimit: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - nom
                - prenom
                - email
                - telephone
                - password
                - role
              properties:
                nom:
                  type: string
                  minLength: 2
                  maxLength: 50
                  pattern: "^[a-zA-Z√Ä-√ø\\s]+$"
                  description: "Nom de l'utilisateur"
                  example: "Kouassi"
                prenom:
                  type: string
                  minLength: 2
                  maxLength: 50
                  pattern: "^[a-zA-Z√Ä-√ø\\s]+$"
                  description: "Pr√©nom de l'utilisateur"
                  example: "Jean"
                email:
                  type: string
                  format: email
                  description: "Email de l'utilisateur"
                  example: "jean.kouassi@soutralideals.com"
                telephone:
                  type: string
                  pattern: "^\\+225[0-9]{8}$"
                  description: "Num√©ro de t√©l√©phone ivoirien"
                  example: "+22512345678"
                password:
                  type: string
                  minLength: 8
                  pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)"
                  description: "Mot de passe (min 8 caract√®res, 1 minuscule, 1 majuscule, 1 chiffre)"
                  example: "MotDePasse123"
                role:
                  type: string
                  enum: [Client, Prestataire, Vendeur, Freelance]
                  description: "R√¥le de l'utilisateur"
                  example: "Client"
      responses:
        '201':
          description: "Compte cr√©√© avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Utilisateur cr√©√© avec succ√®s"
                  user:
                    type: object
                    description: "Informations utilisateur cr√©√©"
        '400':
          description: "Donn√©es de validation invalides"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: "Trop de tentatives d'inscription"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'

components:
  securitySchemes:
    rateLimit:
      type: apiKey
      in: header
      name: X-Rate-Limit
      description: "Rate limiting appliqu√© (100 req/15min par IP, 5 auth/15min par IP)"
    
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: "Token JWT pour l'authentification"
      x-rate-limit: "100 requ√™tes par 15 minutes"

  schemas:
    RateLimitError:
      type: object
      required:
        - error
        - retryAfter
      properties:
        error:
          type: string
          description: "Message d'erreur de rate limiting"
          example: "Trop de requ√™tes depuis cette IP, veuillez r√©essayer plus tard."
        retryAfter:
          type: string
          description: "Temps d'attente avant nouvelle tentative"
          example: "15 minutes"
      example:
        error: "Trop de requ√™tes depuis cette IP, veuillez r√©essayer plus tard."
        retryAfter: "15 minutes"

    ValidationError:
      type: object
      required:
        - error
        - details
      properties:
        error:
          type: string
          description: "Message d'erreur g√©n√©ral"
          example: "Donn√©es de validation invalides"
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
                description: "Champ en erreur"
                example: "email"
              message:
                type: string
                description: "Message d'erreur sp√©cifique"
                example: "Email invalide"
              value:
                type: string
                description: "Valeur fournie"
                example: "email-invalide"
      example:
        error: "Donn√©es de validation invalides"
        details:
          - field: "email"
            message: "Email invalide"
            value: "email-invalide"
          - field: "password"
            message: "Le mot de passe doit contenir au moins 8 caract√®res"
            value: "123"

    SecurityHeaders:
      type: object
      description: "Headers de s√©curit√© appliqu√©s par Helmet"
      properties:
        "X-Content-Type-Options":
          type: string
          example: "nosniff"
        "X-Frame-Options":
          type: string
          example: "DENY"
        "X-XSS-Protection":
          type: string
          example: "1; mode=block"
        "Strict-Transport-Security":
          type: string
          example: "max-age=31536000; includeSubDomains"
        "Content-Security-Policy":
          type: string
          example: "default-src 'self'; style-src 'self' 'unsafe-inline'"

    CacheHeaders:
      type: object
      description: "Headers de cache pour les r√©ponses"
      properties:
        "Cache-Control":
          type: string
          example: "public, max-age=300"
        "ETag":
          type: string
          example: "\"abc123\""
        "Last-Modified":
          type: string
          format: date-time
          example: "2024-01-15T10:30:00.000Z"

  # üõ°Ô∏è NOUVELLES ROUTES DE S√âCURIT√â
  /api/security/user/{utilisateurId}:
    get:
      tags:
        - S√©curit√©
      summary: "üõ°Ô∏è Informations de s√©curit√© d'un utilisateur"
      description: "R√©cup√©rer toutes les informations de s√©curit√© d'un utilisateur (2FA, sessions, alertes)"
      security:
        - bearerAuth: []
      parameters:
        - name: utilisateurId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'utilisateur"
          example: "64f1a2b3c4d5e6f7g8h9i0j1"
      responses:
        200:
          description: "Informations de s√©curit√© r√©cup√©r√©es avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      utilisateurId:
                        type: string
                        example: "64f1a2b3c4d5e6f7g8h9i0j1"
                      twoFactorEnabled:
                        type: boolean
                        description: "2FA activ√©"
                        example: true
                      lastLogin:
                        type: string
                        format: date-time
                        example: "2024-01-15T10:30:00.000Z"
                      activeSessions:
                        type: integer
                        description: "Nombre de sessions actives"
                        example: 2
                      securityAlerts:
                        type: integer
                        description: "Nombre d'alertes de s√©curit√©"
                        example: 3
                      trustedDevices:
                        type: integer
                        description: "Nombre d'appareils de confiance"
                        example: 1
        404:
          description: "Utilisateur non trouv√©"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/security/user/{utilisateurId}/stats:
    get:
      tags:
        - S√©curit√©
      summary: "üìä Statistiques de s√©curit√© d'un utilisateur"
      description: "R√©cup√©rer les statistiques de s√©curit√© d√©taill√©es d'un utilisateur"
      security:
        - bearerAuth: []
      parameters:
        - name: utilisateurId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'utilisateur"
          example: "64f1a2b3c4d5e6f7g8h9i0j1"
      responses:
        200:
          description: "Statistiques r√©cup√©r√©es avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      totalLogins:
                        type: integer
                        example: 45
                      failedLogins:
                        type: integer
                        example: 3
                      lastFailedLogin:
                        type: string
                        format: date-time
                        example: "2024-01-10T14:20:00.000Z"
                      securityScore:
                        type: integer
                        minimum: 0
                        maximum: 100
                        example: 85
                      alertsCount:
                        type: integer
                        example: 3
                      sessionsCount:
                        type: integer
                        example: 2

  /api/security/user/{utilisateurId}/2fa/enable:
    post:
      tags:
        - S√©curit√©
      summary: "üîê Activer l'authentification √† deux facteurs"
      description: "Activer la 2FA pour un utilisateur et g√©n√©rer un QR code"
      security:
        - bearerAuth: []
      parameters:
        - name: utilisateurId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'utilisateur"
          example: "64f1a2b3c4d5e6f7g8h9i0j1"
      responses:
        200:
          description: "2FA activ√© avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "2FA activ√© avec succ√®s"
                  data:
                    type: object
                    properties:
                      secret:
                        type: string
                        description: "Cl√© secr√®te pour l'authentificateur"
                        example: "JBSWY3DPEHPK3PXP"
                      qrCode:
                        type: string
                        description: "URL du QR code"
                        example: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..."
                      backupCodes:
                        type: array
                        items:
                          type: string
                        description: "Codes de r√©cup√©ration"
                        example: ["12345678", "87654321", "11223344"]
        400:
          description: "2FA d√©j√† activ√©"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/security/user/{utilisateurId}/2fa/verify:
    post:
      tags:
        - S√©curit√©
      summary: "‚úÖ V√©rifier le code 2FA"
      description: "V√©rifier un code 2FA pour finaliser l'activation"
      security:
        - bearerAuth: []
      parameters:
        - name: utilisateurId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'utilisateur"
          example: "64f1a2b3c4d5e6f7g8h9i0j1"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - code
              properties:
                code:
                  type: string
                  description: "Code 2FA √† 6 chiffres"
                  example: "123456"
      responses:
        200:
          description: "Code 2FA v√©rifi√© avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "2FA activ√© avec succ√®s"
        400:
          description: "Code 2FA invalide"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/security/user/{utilisateurId}/2fa/disable:
    post:
      tags:
        - S√©curit√©
      summary: "‚ùå D√©sactiver l'authentification √† deux facteurs"
      description: "D√©sactiver la 2FA pour un utilisateur"
      security:
        - bearerAuth: []
      parameters:
        - name: utilisateurId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'utilisateur"
          example: "64f1a2b3c4d5e6f7g8h9i0j1"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - password
              properties:
                password:
                  type: string
                  description: "Mot de passe de confirmation"
                  example: "motdepasse123"
      responses:
        200:
          description: "2FA d√©sactiv√© avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "2FA d√©sactiv√© avec succ√®s"
        400:
          description: "Mot de passe incorrect"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/security/user/{utilisateurId}/sessions:
    get:
      tags:
        - S√©curit√©
      summary: "üì± Sessions actives d'un utilisateur"
      description: "R√©cup√©rer la liste des sessions actives d'un utilisateur"
      security:
        - bearerAuth: []
      parameters:
        - name: utilisateurId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'utilisateur"
          example: "64f1a2b3c4d5e6f7g8h9i0j1"
      responses:
        200:
          description: "Sessions r√©cup√©r√©es avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        sessionId:
                          type: string
                          example: "sess_123456789"
                        device:
                          type: string
                          example: "iPhone 13 Pro"
                        browser:
                          type: string
                          example: "Safari 15.0"
                        location:
                          type: string
                          example: "Abidjan, C√¥te d'Ivoire"
                        ipAddress:
                          type: string
                          example: "197.149.90.123"
                        isCurrent:
                          type: boolean
                          example: true
                        lastActivity:
                          type: string
                          format: date-time
                          example: "2024-01-15T10:30:00.000Z"
                        createdAt:
                          type: string
                          format: date-time
                          example: "2024-01-15T09:00:00.000Z"

  /api/security/user/{utilisateurId}/sessions/{sessionId}:
    delete:
      tags:
        - S√©curit√©
      summary: "üö™ Terminer une session"
      description: "Terminer une session sp√©cifique d'un utilisateur"
      security:
        - bearerAuth: []
      parameters:
        - name: utilisateurId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'utilisateur"
          example: "64f1a2b3c4d5e6f7g8h9i0j1"
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          description: "ID de la session"
          example: "sess_123456789"
      responses:
        200:
          description: "Session termin√©e avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Session termin√©e avec succ√®s"
        404:
          description: "Session non trouv√©e"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/security/user/{utilisateurId}/history:
    get:
      tags:
        - S√©curit√©
      summary: "üìú Historique de connexion"
      description: "R√©cup√©rer l'historique des connexions d'un utilisateur"
      security:
        - bearerAuth: []
      parameters:
        - name: utilisateurId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'utilisateur"
          example: "64f1a2b3c4d5e6f7g8h9i0j1"
        - name: page
          in: query
          schema:
            type: integer
            default: 1
          description: "Num√©ro de page"
          example: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
          description: "Nombre d'√©l√©ments par page"
          example: 20
      responses:
        200:
          description: "Historique r√©cup√©r√© avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        _id:
                          type: string
                          example: "hist_123456789"
                        action:
                          type: string
                          example: "login"
                        success:
                          type: boolean
                          example: true
                        ipAddress:
                          type: string
                          example: "197.149.90.123"
                        userAgent:
                          type: string
                          example: "Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X)"
                        location:
                          type: string
                          example: "Abidjan, C√¥te d'Ivoire"
                        timestamp:
                          type: string
                          format: date-time
                          example: "2024-01-15T10:30:00.000Z"

  /api/security/user/{utilisateurId}/alerts:
    get:
      tags:
        - S√©curit√©
      summary: "üö® Alertes de s√©curit√©"
      description: "R√©cup√©rer les alertes de s√©curit√© d'un utilisateur"
      security:
        - bearerAuth: []
      parameters:
        - name: utilisateurId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'utilisateur"
          example: "64f1a2b3c4d5e6f7g8h9i0j1"
        - name: status
          in: query
          schema:
            type: string
            enum: [all, unread, read]
            default: all
          description: "Filtrer par statut"
          example: "unread"
        - name: priority
          in: query
          schema:
            type: string
            enum: [low, medium, high, critical]
          description: "Filtrer par priorit√©"
          example: "high"
      responses:
        200:
          description: "Alertes r√©cup√©r√©es avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        _id:
                          type: string
                          example: "alert_123456789"
                        type:
                          type: string
                          example: "suspicious_login"
                        title:
                          type: string
                          example: "Connexion suspecte d√©tect√©e"
                        message:
                          type: string
                          example: "Une connexion depuis un nouvel appareil a √©t√© d√©tect√©e"
                        priority:
                          type: string
                          enum: [low, medium, high, critical]
                          example: "high"
                        isRead:
                          type: boolean
                          example: false
                        metadata:
                          type: object
                          properties:
                            ipAddress:
                              type: string
                              example: "197.149.90.123"
                            location:
                              type: string
                              example: "Abidjan, C√¥te d'Ivoire"
                            device:
                              type: string
                              example: "iPhone 13 Pro"
                        createdAt:
                          type: string
                          format: date-time
                          example: "2024-01-15T10:30:00.000Z"

  /api/security/user/{utilisateurId}/alerts/{alertId}/read:
    patch:
      tags:
        - S√©curit√©
      summary: "‚úÖ Marquer une alerte comme lue"
      description: "Marquer une alerte de s√©curit√© comme lue"
      security:
        - bearerAuth: []
      parameters:
        - name: utilisateurId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'utilisateur"
          example: "64f1a2b3c4d5e6f7g8h9i0j1"
        - name: alertId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'alerte"
          example: "alert_123456789"
      responses:
        200:
          description: "Alerte marqu√©e comme lue avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Alerte marqu√©e comme lue"
        404:
          description: "Alerte non trouv√©e"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/security/user/{utilisateurId}/devices:
    get:
      tags:
        - S√©curit√©
      summary: "üì± Appareils de confiance"
      description: "R√©cup√©rer la liste des appareils de confiance d'un utilisateur"
      security:
        - bearerAuth: []
      parameters:
        - name: utilisateurId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'utilisateur"
          example: "64f1a2b3c4d5e6f7g8h9i0j1"
      responses:
        200:
          description: "Appareils r√©cup√©r√©s avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        _id:
                          type: string
                          example: "device_123456789"
                        name:
                          type: string
                          example: "Mon iPhone"
                        type:
                          type: string
                          example: "mobile"
                        fingerprint:
                          type: string
                          example: "abc123def456"
                        lastUsed:
                          type: string
                          format: date-time
                          example: "2024-01-15T10:30:00.000Z"
                        createdAt:
                          type: string
                          format: date-time
                          example: "2024-01-10T09:00:00.000Z"

  /api/security/user/{utilisateurId}/devices/{deviceId}:
    delete:
      tags:
        - S√©curit√©
      summary: "üóëÔ∏è Supprimer un appareil de confiance"
      description: "Supprimer un appareil de confiance d'un utilisateur"
      security:
        - bearerAuth: []
      parameters:
        - name: utilisateurId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'utilisateur"
          example: "64f1a2b3c4d5e6f7g8h9i0j1"
        - name: deviceId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'appareil"
          example: "device_123456789"
      responses:
        200:
          description: "Appareil supprim√© avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Appareil supprim√© avec succ√®s"
        404:
          description: "Appareil non trouv√©"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/security/user/{utilisateurId}/settings:
    put:
      tags:
        - S√©curit√©
      summary: "‚öôÔ∏è Param√®tres de s√©curit√©"
      description: "Mettre √† jour les param√®tres de s√©curit√© d'un utilisateur"
      security:
        - bearerAuth: []
      parameters:
        - name: utilisateurId
          in: path
          required: true
          schema:
            type: string
          description: "ID de l'utilisateur"
          example: "64f1a2b3c4d5e6f7g8h9i0j1"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                emailNotifications:
                  type: boolean
                  description: "Notifications par email"
                  example: true
                smsNotifications:
                  type: boolean
                  description: "Notifications par SMS"
                  example: false
                loginAlerts:
                  type: boolean
                  description: "Alertes de connexion"
                  example: true
                suspiciousActivityAlerts:
                  type: boolean
                  description: "Alertes d'activit√© suspecte"
                  example: true
                sessionTimeout:
                  type: integer
                  description: "Timeout de session en minutes"
                  example: 30
                maxConcurrentSessions:
                  type: integer
                  description: "Nombre maximum de sessions simultan√©es"
                  example: 3
      responses:
        200:
          description: "Param√®tres mis √† jour avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Param√®tres mis √† jour avec succ√®s"
                  data:
                    type: object
                    properties:
                      emailNotifications:
                        type: boolean
                        example: true
                      smsNotifications:
                        type: boolean
                        example: false
                      loginAlerts:
                        type: boolean
                        example: true
                      suspiciousActivityAlerts:
                        type: boolean
                        example: true
                      sessionTimeout:
                        type: integer
                        example: 30
                      maxConcurrentSessions:
                        type: integer
                        example: 3

  /api/security/stats:
    get:
      tags:
        - S√©curit√©
      summary: "üìä Statistiques globales de s√©curit√© (Admin)"
      description: "R√©cup√©rer les statistiques globales de s√©curit√© (r√©serv√© aux administrateurs)"
      security:
        - bearerAuth: []
      responses:
        200:
          description: "Statistiques r√©cup√©r√©es avec succ√®s"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      totalUsers:
                        type: integer
                        description: "Nombre total d'utilisateurs"
                        example: 1250
                      usersWith2FA:
                        type: integer
                        description: "Utilisateurs avec 2FA activ√©"
                        example: 800
                      totalSessions:
                        type: integer
                        description: "Nombre total de sessions actives"
                        example: 2000
                      securityAlerts:
                        type: integer
                        description: "Nombre total d'alertes de s√©curit√©"
                        example: 150
                      failedLogins:
                        type: integer
                        description: "Tentatives de connexion √©chou√©es (24h)"
                        example: 25
                      securityScore:
                        type: number
                        description: "Score de s√©curit√© global (0-100)"
                        example: 85.5
        401:
          description: "Non autoris√©"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'



